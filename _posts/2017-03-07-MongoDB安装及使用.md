---
layout:     post
title:      "MongoDB安装配置使用"
subtitle:   ""
date:       2017-03-07 00:00:00
author:     "alvy"
header-img: "img/post-bg-database.jpg"
header-mask: 0.3
catalog:    true
tags:
    - database
    - MongoDB
---

##### 安装

参照官方文档：[https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/#configure-selinux](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/#configure-selinux)

1. 配置Yum源

   创建一个Yum源文件`/etc/yum.repos.d/mongodb-org-3.4.repo`，将下面的内容添加进去：

   ```
   [mongodb-org-3.4]
   name=MongoDB Repository
   baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/
   gpgcheck=1
   enabled=1
   gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc
   ```

   > 上面的`$releasever`替换成相应的redhat版本，可访问此路劲来检查是否正确

2. 安装

   ```shell
   $ yum install -y mongodb-org
   ```

##### 配置

>The MongoDB instance stores its data files in /var/lib/mongo and its log files in /var/log/mongodb by default, and runs using the mongod user account. You can specify alternate log and data file directories in /etc/mongod.conf. See systemLog.path and storage.dbPath for additional information.    

可以自己配置日志路径和数据路径，并将此两个路径修改用户组
```shell
$ chown -R mongod:mongod <directory>
```
修改配置文件里的相关路径，例如：

```
# where to write logging data.
systemLog:
  ...
  path: /home/work/mongodb/log/mongod.log

# Where and how to store data.
storage:
  dbPath: /home/work/mongodb/data
  ...

# how the process runs
processManagement:
  ...
  pidFilePath: /home/work/mongodb/mongod.pid
```

##### 启动

- service启动

  官方文档里*Configure SELinux*根据情况可以忽略

  ```shell
  $ service mongod start
  $ service mongod stop
  $ service mongod status
  $ service mongod restart
  ```

  启动服务后，发现状态错误，错误码是：Unexpected mongo exit code 48 

  可能是默认端口27017被占用，kill之后重新启动

  处理办法参照[Unexpected mongo exit code 48 - restarting in Meteor](http://stackoverflow.com/questions/34365779/unexpected-mongo-exit-code-48-restarting-in-meteor)

  ```shell
  $ sudo lsof -i :27017
  COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
  mongod  26463 root    6u  IPv4 984214      0t0  TCP *:27017 (LISTEN)
  $ kill 26463
  ```

- mongod启动

  ```shell
  $ which mongod
  /usr/local/bin/mongod
  # 路径根据实际情况修改
  $ /usr/local/bin/mongod --config /usr/local/mongodb/conf/mongo.cnf
  ```

##### 错误解决办法

1. 无法启动

   ```shell
   $ mongo
   MongoDB shell version v3.4.3
   connecting to: mongodb://127.0.0.1:27017
   2017-03-30T10:20:02.430+0800 W NETWORK  [thread1] Failed to connect to 127.0.0.1:27017, in(checking socket for error after poll), reason: Connection refused
   2017-03-30T10:20:02.430+0800 E QUERY    [thread1] Error: couldn't connect to server 127.0.0.1:27017, connection attempt failed :
   connect@src/mongo/shell/mongo.js:237:13
   @(connect):1:6
   exception: connect failed
   ```

   参考资料：[http://stackoverflow.com/questions/12831939/couldnt-connect-to-server-127-0-0-127017](http://stackoverflow.com/questions/12831939/couldnt-connect-to-server-127-0-0-127017)

   > 包括其他的无法启动和无法进入客户端，也可以用此方法，例如:
   >
   > ```
   > got signal 15 (Terminated), will terminate after current cmd ends
   > ```

   一般是因为修改配置文件配置了新的日志路径和数据路径，需要初始化，在本例子中的命令如下：

   ```shell
   $ rm /home/work/mongodb/data/mongod.lock
   $ /usr/bin/mongod --repair --dbpath /home/work/mongodb/data/
   $ /usr/bin/mongod --fork --logpath /home/work/mongodb/log/mongod.log --dbpath /home/work/mongodb/data/
   ```

   > mongod的路径可通过`whereis mongod`来获取

2. data path permission    
   如果我们自定义数据路径的话，会遇到权限问题，需要更改用户组为mongod，如果没有安装正常流程安装，比如从别的服务器直接复制mongo安装文件，会出现没有mongod用户的情况，如下所示：    

   ```shell
   $ chown -R mongod:mongod mongodb-data/    
   invalid user mongod
   ```

   这时我们可以修改路径权限来解决

   ```shell
   $ chmod 755 -R mongodb-data/
   ```
##### 进入客户端警告

进入mongo shell，我们会看到若干警告：

```shell
shell> mongo
MongoDB shell version v3.4.2
connecting to: mongodb://127.0.0.1:27017
MongoDB server version: 3.4.2
Server has startup warnings:
2017-02-21T14:22:10.269+0800 I STORAGE  [initandlisten]
2017-02-21T14:22:10.269+0800 I STORAGE  [initandlisten] ** WARNING: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine
2017-02-21T14:22:10.269+0800 I STORAGE  [initandlisten] **          See http://dochub.mongodb.org/core/prodnotes-filesystem
2017-02-21T14:22:10.408+0800 I CONTROL  [initandlisten]
2017-02-21T14:22:10.408+0800 I CONTROL  [initandlisten] ** WARNING: Access control is not enabled for the database.
2017-02-21T14:22:10.408+0800 I CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.
2017-02-21T14:22:10.408+0800 I CONTROL  [initandlisten]
2017-02-21T14:22:10.408+0800 I CONTROL  [initandlisten]
2017-02-21T14:22:10.408+0800 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is 'always'.
2017-02-21T14:22:10.408+0800 I CONTROL  [initandlisten] **        We suggest setting it to 'never'
2017-02-21T14:22:10.408+0800 I CONTROL  [initandlisten]
2017-02-21T14:22:10.408+0800 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is 'always'.
2017-02-21T14:22:10.408+0800 I CONTROL  [initandlisten] **        We suggest setting it to 'never'
2017-02-21T14:22:10.408+0800 I CONTROL  [initandlisten]
```

1. ** WARNING: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine

   参照[http://dba.stackexchange.com/questions/160538/mongodb-unable-to-change-mongodb-storage-engine-to-wiredtiger](http://dba.stackexchange.com/questions/160538/mongodb-unable-to-change-mongodb-storage-engine-to-wiredtiger)

   简而言之：我们一般存的数据路径的文件系统是ext，但是MongoDB3.2+推荐的文件系统是WiredTiger，所以会出现此警告

   解决办法：

   - Host your `dbPath` on a supported filesystem other than ext4 (XFS is recommended)
   - Start your `mongo` shell with the `--quiet` parameter (which might suppress other interesting startup info / warnings)


##### 用户管理

MongoDB默认用户认证是关闭的，也就是说访问MongoDB是没有限制的，下面说明如何配置认证

参考地址：[https://docs.mongodb.com/manual/tutorial/enable-authentication/](https://docs.mongodb.com/manual/tutorial/enable-authentication/)

1. 进入MongoDB shell

2. 创建用户管理员

   ```shell
   use admin
   db.createUser(
     {
       user: "myUserAdmin",
       pwd: "xyz123",
       roles: [ { role: "userAdminAnyDatabase", db: "admin" } ]
     }
   )
   ```

   断开shell

3. 修改配置，重新启动mongod服务

   配置如下：

   ```
   security:
      authorization: enabled
   ```

4. 对生产数据库创建用户

   这个时候我们如果用`mongo`直接进入mongo shell，会发现什么都做不了，比如显示数据库，切换数据库，都会提示没有认证。所以我们需要加上用户、密码和有权限的数据库名称：

   ```shell
   shell> mongo -u "myUserAdmin" -p --authenticationDatabase "admin"
   ```

   这个用户`myUserAdmin`拥有管理用户和角色的权限，我们可以对生产数据库创建用户：

   ```
   use test
   db.createUser(
     {
       user: "ksxing_admin",
       pwd: "ksxing18600361214",
       roles: [ { role: "readWrite", db: "test" }]
     }
   )
   ```

   role可以使用MongoDB的默认role，这里创建了一个用户`myTester`，他对`test`有读写权限，（注意：必须先切换到test数据库）

5. 用`myTester`连接和认证

   ```shell
   shell> mongo -u "myTester" -p --authenticationDatabase "test"
   ```

   链接之后我们可以切换到`test`，可以读写，但是创建用户，对别的数据库读写，是不行的

6. pyMongo测试

   参照[http://api.mongodb.com/python/current/examples/authentication.html](http://api.mongodb.com/python/current/examples/authentication.html)

   如果MongoDB没有设置认证，那么秩序配置host就可以连接了

   如果设置了认证，那么就需要额外配置用户、密码、认证方式了，MongoDB的版本是3.0+的话认证方式是`SCRAM-SHA-1`（版本可在MongoDB shell里用`db.version()`来查看）

   ```shell
   >>> from pymongo import MongoClient
   >>> uri="mongodb://{}:{}@{}/{}?authMechanism={}".format('myTester','xyz123','127.0.0.1','test','SCRAM-SHA-1')
   >>> client = MongoClient(uri)
   >>> db=client.test
   >>> a=db.foo
   >>> b=a.find()
   >>> b.next()
   {u'y': 1.0, u'x': 1.0, u'_id': ObjectId('58ae4cca9afbf0c6ef59bb0d')}
   ```

##### 备份

1. 物理备份    
   将原有数据路径整个打包复制到新的服务器路径，然后将配置文件里的数据路径指向此文件夹即可

##### 相关命令

- 查看索引

  ```shell
  > db.collection.getIndexes()
  ```

- 创建索引

  ```shell
  > db.collection.ensureIndex({"resut_id": 1})
  ```

- 删除集合collection

  ```shell
  > db.collection.drop()
  ```

- 按条件删除记录

  ```shell
  > db.collection.remove({"result_id":"435"})
  ```

##### 使用方法

- group分组

  ```shell
  {
  	"_id" : ObjectId("5982e69fe2c69210c86b598a"),
  	"testTittle" : "",
  	"encrypt" : "0",
  	"classification" : "42371",
  	"question" : "qqqq",
  	"tabNum" : "",
  	"status" : "enable",
  	"key1" : "0",
  	"key2" : "1",
  	"answer1" : "",
  	"answer2" : "",
  	"type" : "3",
  	"id" : "",
  	"analysis" : "",
  	"difficult" : "middle",
  	"testPeerScore" : "",
  	"creater" : "13020030505@2351",
  	"createDate" : "2017-08-03 17:02:23",
  	"cop_id" : "2351"
  }
  ```

  MongoDB里的数据如上，我们要实现按question字段分组，获取questions重复的条目，代码如下：

  ```python
  key = {"question": 1}
  condition = arg_new
  initial = {"count": 0, "doc": []}
  from bson.code import Code
  reducer = Code("""
                 function(obj, prev){
                   prev.count++;
                   prev.doc.push(obj._id);
                   return prev;
                 }
                 """)
  result = con.group(key, condition, initial, reducer)
  for prev in result:
      count = prev.get("count")
      if int(count) == 1:
          continue
      for doc in prev["doc"]:
          test_all.append(doc)
  ```

